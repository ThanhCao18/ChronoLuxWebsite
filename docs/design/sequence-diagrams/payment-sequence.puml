@startuml Payment Sequence Diagram

actor User
participant "CheckoutController" as CC
participant "PaymentVNPayController" as PVC
participant "BillService" as BS
participant "UserService" as US
participant "ProductService" as PS
participant "VoucherService" as VS
participant "CartUtils" as CU
participant "PaymentVnpayService" as PVS
participant "MailConfig" as MC
database "Database" as DB
database "Session" as S
database "Cookie" as C

== Xem trang thanh toán ==
User -> CC: GET /checkout?subtotal&total&voucherCode
CC -> PS: findAllByActive(true)
PS -> DB: Query products
DB --> PS: Product list
PS --> CC: List<ProductDTO>
CC -> CU: getCartByCookie(cookies, products)
CU --> CC: CartDTO
alt User đã đăng nhập
    CC -> US: getCurrentLoggedInCustomer(authentication)
    US -> DB: Query user
    DB --> US: User data
    US --> CC: UserDTO
end
CC -> CU: getCartItemByAuthentication(cartDTO, userDTO)
CU --> CC: List<CartItemDTO>
alt Có voucher
    CC -> VS: findOneByCode(voucherCode)
    VS -> DB: Query voucher
    DB --> VS: Voucher data
    VS --> CC: VoucherDTO
end
CC --> User: Hiển thị trang thanh toán

== Tạo đơn hàng ==
User -> CC: POST /checkout (billDTO)
alt User đã đăng nhập
    CC -> US: getCurrentLoggedInCustomer(authentication)
    US -> DB: Query user
    DB --> US: User data
    US --> CC: UserDTO
    CC -> BS: save(billDTO)
    BS -> DB: Save bill
    DB --> BS: Saved bill
    BS --> CC: BillDTO
    CC -> VS: findOneByCode(billDTO.getVoucherCode())
    VS -> DB: Query voucher
    DB --> VS: Voucher data
    VS --> CC: VoucherDTO
    alt Voucher là private
        CC -> VS: setExpiredDate(voucherCode, now)
        VS -> DB: Update voucher
        DB --> VS: Updated
    end
    CC -> CU: getCartItemByAuthentication(cartDTO, userDTO)
    CU --> CC: List<CartItemDTO>
    CC -> MC: sendEmailAsync(billDTO.getEmail(), cartItems, billDTO)
    CC -> MC: sendEmailToAdminAsync(adminEmail, cartItems, billDTO)
    CC -> CU: DeleteCartItemByAuthentication(userDTO, cartDTO, txt, response)
    CU --> CC: Success
    CC --> User: Redirect to success page
end

== Thanh toán VNPay ==
User -> PVC: GET /payment/create-payment
PVC -> PVS: createPayMent(request, billDTO)
PVS --> PVC: Payment URL
PVC --> User: Redirect to VNPay

== Xử lý kết quả thanh toán VNPay ==
User -> PVC: GET /payment/execute-payment
PVC -> PVS: getSignValue(request)
PVS --> PVC: Sign value
alt Sign hợp lệ
    alt Thanh toán thành công
        PVC -> S: getAttribute("bill")
        S --> PVC: BillDTO
        PVC -> PS: findAllByActive(true)
        PS -> DB: Query products
        DB --> PS: Product list
        PS --> PVC: List<ProductDTO>
        PVC -> US: getCurrentLoggedInCustomer(authentication)
        US -> DB: Query user
        DB --> US: User data
        US --> PVC: UserDTO
        PVC -> CU: getCartByCookie(cookies, products)
        CU --> PVC: CartDTO
        PVC -> CU: getCartItemByAuthentication(cartDTO, userDTO)
        CU --> PVC: List<CartItemDTO>
        PVC -> BS: save(billDTO)
        BS -> DB: Save bill
        DB --> BS: Saved bill
        BS --> PVC: BillDTO
        PVC -> MC: sendEmailAsync(billDTO.getEmail(), cartItems, billDTO)
        PVC -> MC: sendEmailToAdminAsync(adminEmail, cartItems, billDTO)
        PVC -> CU: DeleteCartItemByAuthentication(userDTO, cartDTO, txt, response)
        CU --> PVC: Success
        PVC -> S: removeAttribute("bill")
        PVC --> User: Redirect to success page
    else Thanh toán thất bại
        PVC -> S: removeAttribute("bill")
        PVC --> User: Redirect to cart
    end
else Sign không hợp lệ
    PVC -> S: removeAttribute("bill")
    PVC --> User: Redirect to cart
end

@enduml 