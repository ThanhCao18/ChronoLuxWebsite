@startuml Cart Management Sequence Diagram

actor User
participant "CartController" as CC
participant "CartUtils" as CU
participant "Services\n(User/Product/Voucher)" as SVC
database "Cookie" as C
database "Database" as DB

== Xem giỏ hàng ==
User -> CC: GET /cart
CC -> SVC: getCurrentLoggedInCustomer()
SVC -> DB: Query user & vouchers & products
DB --> SVC: Data
SVC --> CC: UserDTO, VoucherDTO, ProductDTO
CC -> CU: getCartByCookieAndDeleteCookie()
CU --> CC: CartDTO
alt User đã đăng nhập
    CC -> SVC: findOneById(userDTO.getVoucherId())
    SVC --> CC: VoucherDTO
end
CC -> CU: getCartItemByAuthentication()
CU --> CC: List<CartItemDTO>
CC --> User: Hiển thị trang giỏ hàng

== Thêm sản phẩm vào giỏ ==
User -> CC: GET /cart/add?productId&quantity
CC -> SVC: getCurrentLoggedInCustomer()
SVC --> CC: UserDTO
CC -> C: Read/Update cart cookie
C --> CC: Success
CC --> User: Redirect to cart page

== Cập nhật số lượng sản phẩm ==
User -> CC: GET /cart/update?productId&quantity
CC -> SVC: findAllByActive()
SVC --> CC: List<ProductDTO>
CC -> CU: getCartByCookieAndDeleteCookie()
CU --> CC: CartDTO
alt User đã đăng nhập
    CC -> SVC: getCurrentLoggedInCustomer()
    SVC --> CC: UserDTO
end
CC -> CU: Update cart item quantity
CU --> CC: Updated CartDTO
CC -> C: Update cart cookie
C --> CC: Success
CC --> User: Redirect to cart page

== Xóa sản phẩm khỏi giỏ ==
User -> CC: GET /cart/del?productId
CC -> SVC: findAllByActive()
SVC --> CC: List<ProductDTO>
CC -> CU: getCartByCookieAndDeleteCookie()
CU --> CC: CartDTO
alt User đã đăng nhập
    CC -> SVC: getCurrentLoggedInCustomer()
    SVC --> CC: UserDTO
end
CC -> CU: DeleteCartItemByProductIdAndAuthentication()
CU --> CC: Updated CartDTO
CC --> User: Redirect to cart page

== Lấy tổng số sản phẩm trong giỏ ==
User -> CC: GET /cart/total
alt User đã đăng nhập
    CC -> SVC: getCurrentLoggedInCustomer()
    SVC --> CC: UserDTO
end
CC -> SVC: findAllByActive()
SVC --> CC: List<ProductDTO>
CC -> CU: getCartByCookie()
CU --> CC: CartDTO
CC -> CU: GetTotalCartItemByAuthentication()
CU --> CC: Total items
CC --> User: Return total items

@enduml 