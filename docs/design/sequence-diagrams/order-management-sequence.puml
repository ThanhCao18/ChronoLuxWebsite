@startuml Order Management Sequence Diagram

actor Admin
participant "OrderController" as OC
participant "OrderService" as OS
participant "ProductService" as PS
participant "NotificationService" as NS
participant "InventoryService" as IS
participant "OrderHistoryService" as OHS
database "Database" as DB

== Xem danh sách đơn hàng ==
Admin -> OC: GET /admin/order?page&limit&status&keyword
OC -> OS: findAll(page, limit, status, keyword)
OS -> DB: Query orders with filters
DB --> OS: Order list with customer info
OS --> OC: Page<OrderDTO>
OC --> Admin: Hiển thị trang danh sách đơn hàng\n(Mã đơn, KH, Tổng tiền, Trạng thái, Ngày đặt, PT thanh toán)

== Xem chi tiết đơn hàng ==
Admin -> OC: GET /admin/order/detail?id
OC -> OS: findOneById(id)
OS -> DB: Query order with details
DB --> OS: Order data with products
OS -> OHS: getOrderHistory(orderId)
OHS -> DB: Query order history
DB --> OHS: History records
OHS --> OS: OrderHistoryDTO
OS --> OC: OrderDTO with history
OC --> Admin: Hiển thị trang chi tiết đơn hàng\n(Thông tin KH, SP, Số lượng, Giá, Tổng tiền, PT thanh toán, Địa chỉ, Lịch sử, Ghi chú)

== Cập nhật trạng thái đơn hàng ==
Admin -> OC: POST /admin/order/update-status (orderId, status)
OC -> OS: updateStatus(orderId, status)
OS -> OHS: recordStatusChange(orderId, status)
OHS -> DB: Save status change
OS -> NS: sendStatusNotification(orderId, status)
NS -> DB: Save notification
OS -> DB: Update order status
DB --> OS: Updated order
OS --> OC: OrderDTO
OC --> Admin: Redirect to order list

== Hủy đơn hàng ==
Admin -> OC: POST /admin/order/cancel (orderId, reason)
OC -> OS: cancelOrder(orderId, reason)
OS -> OHS: recordStatusChange(orderId, CANCELLED, reason)
OHS -> DB: Save status change
OS -> IS: restoreInventory(orderId)
IS -> DB: Update product quantities
OS -> NS: sendCancellationNotification(orderId, reason)
NS -> DB: Save notification
OS -> DB: Update order status to CANCELLED
DB --> OS: Updated order
OS --> OC: OrderDTO
OC --> Admin: Redirect to order list

== Xác nhận đơn hàng ==
Admin -> OC: POST /admin/order/confirm (orderId)
OC -> OS: confirmOrder(orderId)
OS -> OS: validateOrder(orderId)
OS -> OHS: recordStatusChange(orderId, CONFIRMED)
OHS -> DB: Save status change
OS -> IS: reserveInventory(orderId)
IS -> DB: Update product quantities
OS -> NS: sendConfirmationNotification(orderId)
NS -> DB: Save notification
OS -> DB: Update order status to CONFIRMED
DB --> OS: Updated order
OS --> OC: OrderDTO
OC --> Admin: Redirect to order list

== Hoàn thành đơn hàng ==
Admin -> OC: POST /admin/order/complete (orderId)
OC -> OS: completeOrder(orderId)
OS -> OHS: recordStatusChange(orderId, COMPLETED)
OHS -> DB: Save status change
OS -> IS: finalizeInventory(orderId)
IS -> DB: Update product quantities
OS -> OS: updateSalesStatistics(orderId)
OS -> DB: Update sales data
OS -> NS: sendCompletionNotification(orderId)
NS -> DB: Save notification
OS -> DB: Update order status to COMPLETED
DB --> OS: Updated order
OS --> OC: OrderDTO
OC --> Admin: Redirect to order list

@enduml 